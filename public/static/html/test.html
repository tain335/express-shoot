<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>Express Shoot Test</title>
		<link rel="stylesheet" href="../css/metro-bootstrap.min.css"/>
        <link rel="stylesheet" href="../css/iconFont.min.css"/>
        <link rel="stylesheet" href="../css/main.css"/>
        <script src="../js/jquery/main.js" type="text/javascript" charset="utf-8"></script>
        <script src="../js/jquery-ui/main.js" type="text/javascript" charset="utf-8"></script>
        <script src="../js/metro/main.js" type="text/javascript" charset="utf-8"></script>
        <script src="../js/shooter-cli/main.js" charset="utf-8"></script>
	</head>
	<body class="metro">
		<header class="header clearfix">
			<h1 class="logo">Express Shoot</h1><!--margin collapse-->
			<div class="shoot-container">
				<div class="input-control text">
			    	<input id="clients" type="text" value="2" placeholder="clients"/>
				    <button class="btn-clear"></button>
				</div>
				<button id="test" class="large primary test-btn">&nbsp;Test&nbsp;</button>
			</div>
		</header>
		<div class="main">
			<nav id="sidebar" class="sidebar light">
            	<form>
	                <fieldset>
	                    <legend>Settings</legend>
	                    <label>Format</label>
	                    <div class="input-control select">
						    <select id="format">
						        <option>png</option>
						        <option>jpeg</option>
						    </select>
						</div>
	                    <label>Viewport Size</label>
	                    <div class="input-control text" data-role="input-control">
	                        <input id="v_w" type="text" placeholder="width" autofocus="" value="1024" style="width: 45%">
	                        x
	                        <input id="v_h" type="text" placeholder="height" autofocus="" value="1024" style="width: 45%">
	                    </div>
	                    <label>ClipRect</label>
	                    <div class="input-control text" data-role="input-control">
	                        <input id="c_t" type="text" placeholder="top" autofocus="" value="0" style="width: 45%">
	                        x
	                        <input id="c_l" type="text" placeholder="left" autofocus="" value="0" style="width: 45%">
	                    </div>
	                     <div class="input-control text" data-role="input-control">
	                        <input id="c_w" type="text" placeholder="width" autofocus="" style="width: 45%">
	                        x
	                        <input id="c_h" type="text" placeholder="height" autofocus="" style="width: 45%">
	                    </div>
	                    <label>Zoom Factor</label>
	                    <div class="input-control text" data-role="input-control">
	                        <input id="z_f" type="text" placeholder="" autofocus="" value="1">
	                    </div>
	                    <label>Quality</label>
	                    <div class="input-control text" data-role="input-control">
	                        <input id="quality" type="text" placeholder="" autofocus="" value="10">
	                    </div>
	                    <!-- <div  class="input-control switch">
						    <label>
						    	Javascript Enabled
						        <input id="js" type="checkbox" checked="checked" />
						        <span class="check"></span>
						    </label>
						</div> -->
	                    <input id="updateSetting" type="submit" value="Update" style="width: 100%; display: block;">
	                </fieldset>
	            </form>
            	<div class="sidebar-footer">
					<a id="toggleSidebar" class="back" href="javascript:void(0)" onclick="return false;"><i class="icon-arrow-left-3"></i></a>
				</div>
        	</nav>
        	<div class="main-content">
        		<div class="img-grid-wrapper">
					<div class="img-grid clearfix">
					</div>
				</div>
				<div class="status"></div>
				<!-- <div class="loading">
					<img src="/images/loading.gif" alt=""/>
				</div> -->
			</div>
		</div>
	</body>
	<script type="text/javascript">
		$(function() {
			var options = fetchOptions();

			var imgBlockTpl = [
				'<div class="img-block-wrapper">',
					'<div class="img-block">',
						'<img src="">',
						'<div class="loading">',
							'<img src="/images/loading.gif" alt=""/>',
						'</div>',
					'</div>',
				'</div>'
			].join('');

			$('.test-btn').on('click', function() {
				var clients = parseInt($('#clients').val());
				$('.img-grid').empty();
				clients = (isNaN(clients)  || clients < 0) ? 0 : clients;
				while(clients--) {
					newRequest();
				}
			});

			$('#updateSetting').on('click', function(evt) {
				evt.preventDefault();
				options = fetchOptions()
				$.Notify.show("Update Successfuly!").close(1000);
			});

			$('#toggleSidebar').click(function() {
				var sidebar = $('#sidebar');
				if(!sidebar.hasClass('close')) {
					sidebar.css('marginLeft', -sidebar.outerWidth());
				} else {
					sidebar.css('marginLeft', 0);
				}
				sidebar.toggleClass('close');
			});

			function fetchOptions() {
				return {
					format: $('#format').find('option:selected').text(),
					viewportSize: {
						width: +$('#v_w').val(),
						height: +$('#v_h').val()
					},
					clipRect: {
						top: +$('#c_t').val(),
						left: +$('#c_l').val(),
						width: $('#c_w').val(),
						height: $('#c_h').val()
					},
					quality: $('#quality').val(),
					zoomFactor: +$('#z_f').val()
					// javascriptEnable: !!$('#js:checked').length
				}
			}

			function newRequest() {
				var client = new ShooterCli("/shoots"),
					$imgBlock = $(imgBlockTpl);
				$('.img-grid').append($imgBlock);
				options.nocache = true;
				client.shoot('http://www.baidu.com', options, 
					function(task) {
						if(task.status === 4) {
							var img = $imgBlock.find('img')[0]; 
							img.onload = function() {
								// $img.addClass('polaroid');
								// $('.metro .image-body').find('img').remove().end().append($img);
								$imgBlock.find('.loading').hide();
							}
							img.src = task.src;
						} else if(task.status === 1) {

						} else if(task.status === 2) {
							$imgBlock.find('.loading').hide();
						}
					}, function(err) {
						$imgBlock.find('.loading').hide();
					});
				$imgBlock.find('.loading').show();
			}
		});
	</script>
</html>